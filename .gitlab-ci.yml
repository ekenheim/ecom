workflow:
  rules:
    - if: $CI_COMMIT_TAG  # Create a pipeline if a tag is pushed
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Otherwise, create a pipeline if it's a push to the default branch

variables:
  # Use Docker-in-Docker service
  # More info: https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  # Improve performance with overlay2 driver
  DOCKER_DRIVER: overlay2
  # Override the clone URL to use the internal Kubernetes service
  GIT_CLONE_URL: http://gitlab-webservice-default.development.svc.cluster.local:8080/${CI_PROJECT_PATH}.git

services:
  - docker:dind # Docker-in-Docker

stages:
  - build

default:
  image: docker:latest # Use a standard docker image for the jobs
  tags:
    - development
    - k8s
  before_script:
    # $CI_REGISTRY_USER, $CI_REGISTRY_PASSWORD, $CI_REGISTRY are predefined GitLab CI/CD variables
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

build_medusa:
  stage: build
  script:
    - cd medusa
    - >
      docker build \
        --tag "$CI_REGISTRY_IMAGE/medusa:$CI_COMMIT_SHORT_SHA" \
        --tag "$CI_REGISTRY_IMAGE/medusa:latest" \
        .
    - docker push "$CI_REGISTRY_IMAGE/medusa:$CI_COMMIT_SHORT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/medusa:latest"
  # Job-level rules still apply, but only if a pipeline was created by the workflow
  rules:
    - if: $CI_COMMIT_TAG # Run for tags
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Run for default branch
      changes:
        - medusa/**/*

build_storefront:
  stage: build
  script:
    - cd storefront
    - >
      docker build \
        --build-arg NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY=$NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY \
        --build-arg NEXT_PUBLIC_SEARCH_API_KEY=$NEXT_PUBLIC_SEARCH_API_KEY \
        --tag "$CI_REGISTRY_IMAGE/storefront:$CI_COMMIT_SHORT_SHA" \
        --tag "$CI_REGISTRY_IMAGE/storefront:latest" \
        .
    - docker push "$CI_REGISTRY_IMAGE/storefront:$CI_COMMIT_SHORT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/storefront:latest"
  # Job-level rules still apply, but only if a pipeline was created by the workflow
  rules:
    - if: $CI_COMMIT_TAG # Run for tags
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Run for default branch
      changes:
        - storefront/**/*